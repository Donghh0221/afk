# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

AFK ("Away From Keyboard") is a Python daemon that serves as a remote control plane for Claude Code. Built for solo entrepreneurs and vibe coders who want to issue commands to Claude Code via Telegram (voice or text) from any device, while a Mac mini runs sessions 24/7.

## Tech Stack

- **Python 3.11+** with **asyncio** (event-driven)
- **python-telegram-bot[ext]>=21.0** — Telegram Bot API (asyncio native)
- **aiohttp>=3.9** — web dashboard server
- **python-dotenv>=1.0** — environment variable loading
- **openai>=1.0** — Whisper API for voice transcription (optional, only if API key is set)
- **Claude Code CLI** — headless mode via `--input-format stream-json --output-format stream-json`
- **uv** — Python package manager (uv.lock)

## Architecture

Hexagonal (port-adapter) architecture with two key abstraction boundaries:

- **MessengerPort** (`messenger/port.py`) — abstract interface for messenger integrations. Core logic depends only on this protocol. MVP adapter: `messenger/telegram/adapter.py` (forum topics for session isolation).
- **STTPort** (`voice/port.py`) — abstract interface for speech-to-text. MVP adapter: `voice/whisper_api.py` (OpenAI Whisper API).

### Core Components (`core/`)

- **Orchestrator** (`orchestrator.py`) — routes incoming messages (text/voice) to the correct session; handles Telegram commands (`/project`, `/new`, `/sessions`, `/stop`, `/complete`, `/status`); displays help for unknown commands
- **SessionManager** (`session_manager.py`) — manages session lifecycle (create/resume/stop), each session = one Claude Code subprocess + one Telegram forum topic + one git worktree
- **ClaudeProcess** (`claude_process.py`) — wraps Claude Code subprocess using stream-json protocol (JSONL on stdin/stdout); supports session resumption via `--resume --session-id`
- **GitWorktree** (`git_worktree.py`) — git worktree/branch management for session isolation; handles worktree creation, commit (with AI-generated messages via Claude CLI), merge back to main, and cleanup

### Data Flow

```
Text message  → TelegramAdapter → Orchestrator → SessionManager → ClaudeProcess (stdin)
Voice message → TelegramAdapter → Orchestrator → WhisperAPI (transcribe) → SessionManager → ClaudeProcess (stdin)

ClaudeProcess (stdout) → parse stream-json → route by type:
  assistant → send to messenger (silent)
  result    → send to messenger
```

### Storage (`storage/`)

- `data/projects.json` — registered project names → local paths
- `data/sessions.json` — session state for daemon restart recovery (channel_id, claude_session_id, trust_level, cost)

## Module Structure

```
afk/
├── main.py              # Entry point, daemon startup, shutdown handling
├── config.py            # Environment settings (tokens, group ID, dashboard port, OpenAI key)
├── messenger/
│   ├── port.py          # MessengerPort protocol (send, edit, create channel, download voice)
│   └── telegram/
│       └── adapter.py   # Telegram bot (forum topics, permission buttons, deep-links)
├── core/
│   ├── orchestrator.py  # Message routing, command handling, Claude response processing
│   ├── session_manager.py # Session lifecycle, persistence, orphan cleanup
│   ├── claude_process.py  # Claude Code subprocess wrapper (stream-json protocol)
│   └── git_worktree.py   # Git worktree/branch operations, AI commit messages
├── voice/
│   ├── port.py          # STTPort protocol (transcribe)
│   └── whisper_api.py   # OpenAI Whisper API implementation
├── dashboard/
│   ├── server.py        # aiohttp web server + API routes
│   ├── message_store.py # Per-session in-memory message history
│   └── index.html       # Single-page dashboard (HTML+CSS+JS)
├── storage/
│   └── project_store.py # Project name → path registry
└── data/                # Runtime data (gitignored)
```

## Telegram Commands

- `/project add|list|remove` — register project names to local paths
- `/new <project_name> [-v|--verbose]` — create new session (worktree + branch + forum topic); `-v`/`--verbose` shows full tool input/output
- `/sessions` — list active sessions with state indicators
- `/stop` — stop current session's Claude process
- `/complete` — auto-commit worktree changes (commit message generated by Claude Code CLI `-p`), merge into main, cleanup
- `/status` — check current session state (name, process alive, project, worktree)
- Unknown commands display help with the list of available commands

## Environment Variables

- `AFK_TELEGRAM_BOT_TOKEN` (required) — Telegram bot token
- `AFK_TELEGRAM_GROUP_ID` (required) — Telegram group/supergroup ID
- `AFK_DASHBOARD_PORT` (optional, default: 7777) — web dashboard port
- `AFK_OPENAI_API_KEY` or `OPENAI_API_KEY` (optional) — enables voice message transcription via Whisper API

## Development Notes

- Session naming convention: `{project_name}-{YYMMDD-HHMMSS}` (e.g. `myapp-260218-143022`)
- Branch naming: `afk/{session_name}` (e.g. `afk/myapp-260218-143022`)
- Worktree directory: `.afk-worktrees/{session_name}`
- Each session runs in an isolated git worktree with its own branch
- `/complete` auto-commits uncommitted changes (commit message generated by Claude Code CLI `-p` mode), then rebases onto main + fast-forward merge
- Orphan worktrees from crashed sessions are cleaned up on daemon startup
- Telegram channel IDs are prefixed with `tg_`
- Telegram messages over 4096 chars are split at newline boundaries
- Silent notifications for assistant (log-like) messages, normal notifications for results/errors
- Deep-links use `tg://privatepost` scheme for reliable iOS Telegram app opening
- Voice support is conditionally enabled only when OpenAI API key is configured
- Detailed architecture spec: `ARCH.md`; product spec with phased roadmap: `PROJECT.md`
